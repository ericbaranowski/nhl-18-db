#!/usr/bin/env python3

import os
import datetime
import yaml

################################################################################
### Constants
################################################################################

DB_DIR = os.path.abspath(os.path.join(os.path.dirname(__file__), '../db/'))

TEAMS = [
    'ana',
    'ari',
    'bos',
    'buf',
    'car',
    'cbj',
    'cgy',
    'chi',
    'col',
    'dal',
    'det',
    'edm',
    'fla',
    'lak',
    'min',
    'mtl',
    'njd',
    'nsh',
    'nyi',
    'nyr',
    'ott',
    'phi',
    'pit',
    'sjs',
    'stl',
    'tbl',
    'tor',
    'van',
    'vgk',
    'wpg',
    'wsh',
]
## Not active teams
## 'phx'
## 'atl'

COUNTRIES = [
    'can',
    'cze',
    'deu',
    'fin',
    'gbr',
    'rus',
    'svk',
    'swe',
    'usa',
    'lva',
    'kaz',
    'nor',
    'che',
]


################################################################################
### Validators
################################################################################

## TODO: more validators

def validate_nhlcom_id(p):
    if not isinstance(p['nhlcom_id'], int):
        print(f"ERROR: player '{p['last_name']}' has bad 'nhlcom_id'")

def validate_country(p):
    n = p['last_name']
    c = p['country_abbrev']
    if not c in COUNTRIES:
        print(f"ERROR: player '{n}' has unknown country '{c}'")

def validate_birthday(p):
    if not isinstance(p['born'], datetime.date):
        print(f"ERROR: player '{p['last_name']}' has invalid birthday")

def validate_player(player_file):
    if not '.yml' in player_file:
        print(f"WARNING: not a .yml file: '{player_file}'")
        return
    f = open(player_file)
    p = yaml.load(f)  # Player dict
    validate_nhlcom_id(p)
    validate_country(p)
    validate_birthday(p)

def validate_team(team_abbrev):
    if not team_abbrev in TEAMS:
        print(f"WARNING: unknown team: '{team_abbrev}'")
        return
    team_dir = os.path.join(DB_DIR, team_abbrev)
    for p in os.listdir(team_dir):
        player_file = os.path.join(team_dir, p)
        validate_player(player_file)

################################################################################
### Main
################################################################################
        
if __name__ == '__main__':
    for d in os.listdir(DB_DIR):
        validate_team(d)
